<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% if version_info and version_info.current_version %}
        <title>ffmpeg4discord v{{ version_info.current_version }}</title>
    {% else %}
        <title>ffmpeg4discord's Web UI</title>
    {% endif %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container">
        <div class="row mt-3">
            <div class="col">
                <h1 class="h3 mb-1">
                    ffmpeg4discord
                    {% if version_info and version_info.current_version %}
                        <small class="text-muted">v{{ version_info.current_version }}</small>
                    {% endif %}
                </h1>
                {% if version_info and version_info.update_available %}
                    <div class="alert alert-warning py-2" role="alert">
                        New version available: <strong>{{ version_info.latest_version }}</strong>
                        (you are running {{ version_info.current_version }}).
                        <span class="ms-2">Upgrade with: <code>pip install -U ffmpeg4discord</code></span>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="row mt-3">
            <div class="alert alert-light" role="alert" {{ "hidden" if alert_hidden else "" }}>
                <p>{{ twopass.message }}</p>
                <span class="text-danger">The server is still running. Do not forget to terminate it.</span>
            </div>
        </div>        
        <div class="row mt-3">
            <video id="myVideo" preload="auto" controls>
                <source src="{{ file_url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <p class="text-muted"><em>Drag the video playhead, and use the buttons below to set the Start and End times.</em></p> 
        </div>
        <form id="encodeForm" action="/encode" method="post">
            <div class="row mb-3">
                <div class="col">
                    <button type="button" class="btn btn-outline-primary" onclick="setTime('start')"><span class="bi-skip-start-fill"></span> Set Start Time</button>
                </div>
                <div class="col">
                    <button type="button" class="btn btn-outline-primary" onclick="setTime('end')">Set End Time <span class="bi-skip-end-fill"></span></button>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label for="startTime" class="form-label padding-top">Start Time:</label>
                    <input class="form-range" type="range" name="startTime" id="startTime" min="0" step="1" max="{{ twopass.duration }}">
                    <span id="startTimeLabel">{{ twopass.from_seconds|string + " seconds" if twopass.from_seconds else "0 seconds" }}</span>
                </div>
                <div class="col">
                    <label for="endTime" class="form-label">End Time:</label>
                    <input class="form-range" type="range" name="endTime" id="endTime" min="0" step="1" max="{{ twopass.duration }}">
                    <span id="endTimeLabel">{{ twopass.to_seconds|string + " seconds" if twopass.to_seconds else twopass.duration|string + " seconds" }}</span>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <button type="button" class="btn btn-outline-primary" onclick="selectVideoPart()"><span class="bi-play"></span> Preview Selection</button>
                </div>
            </div>
            <hr />
            <h3>Output Parameters</h3>
            <div class="row mb-3 row-cols-5">
                <div class="col">
                    <label for="resolution" class="form-label">Resolution</label>
                    <input class="form-control" name="resolution" id="resolution" type="text" value="{{ twopass.resolution }}" />
                </div>
                <div class="col">
                    <label for="target_filesize" class="form-label"><span id="targetApprox">{{ "Approximate" if approx else "Target" }}</span> File Size (MB)</label>
                    <input class="form-control mb-2" name="target_filesize" id="target_filesize" type="text" value="{{ twopass.target_filesize }}" />
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="approx" value="True" name="approx" id="approx" {{ "checked" if approx else "" }}>
                        <label class="form-check-label" for="approx">Approximate file size</label>
                    </div>
                </div>
                <div class="col">
                    <label for="audio_br" class="form-label">Audio Bitrate (kbps)</label>
                    <input class="form-control" name="audio_br" id="audio_br" type="text" value="{{ twopass.audio_br/1000 }}" />
                </div>
                <div class="col">
                    <label for="crop" class="form-label">Crop</label>
                    <input class="form-control" name="crop" id="crop" type="text" value="{{ twopass.crop }}" />
                </div>
                <div class="col">
                    <label for="output" class="form-label">Output Folder/File</label>
                    <input class="form-control" name="output" id="output" type="text" value="{{ twopass.output }}" />
                </div>
                <div class="col">
                    <label for="framerate" class="form-label">Frame Rate</label>
                    <input class="form-control" name="framerate" id="framerate" type="text" value="{{ twopass.framerate if twopass.framerate else '' }}" />
                </div>
                <div class="col">
                    <label for="codec" class="form-label">Video Codec</label>
                    <select name="codec" id="codec" class="form-select">
                        <option {{ "selected" if twopass.codec == "x264" else "" }} value="x264">x264 (.mp4)</option>
                        <option {{ "selected" if twopass.codec == "h264_nvenc" else "" }} value="h264_nvenc">H264 NVENC (.mp4)</option>
                        <option {{ "selected" if twopass.codec == "x265" else "" }} value="x265">x265 (.mp4)</option>
                        <option {{ "selected" if twopass.codec == "hevc_nvenc" else "" }} value="hevc_nvenc">HEVC NVENC (.mp4)</option>
                        <option {{ "selected" if twopass.codec == "vp9" else "" }} value="vp9">VP9 (.web)</option>
                        <option {{ "selected" if twopass.codec == "av1" else "" }} value="av1">AV1 (.mp4)</option>
                    </select>
                </div>
                <div class="col">
                    <label class="form-label d-block">Include Audio</label>
                    <div class="form-check form-switch mt-2">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            role="switch"
                            id="include_audio"
                            name="include_audio"
                            value="True"
                            {{ "checked" if not twopass.no_audio else "" }}
                        >
                        <label class="form-check-label" for="include_audio">Enabled</label>
                    </div>
                </div>
                {% if twopass.audio_streams|length > 1 %}
                <div class="col" id="audioMixingCol">
                    <label class="form-label d-block">Audio Mixing<br /><small><em>({{twopass.audio_streams|length}} audio tracks found)</small></em></label>
                    <div class="form-check">
                        <input
                            class="form-check-input"
                            type="radio"
                            name="amix_mode"
                            id="amix_off"
                            value="off"
                            {% if not twopass.amix %}checked{% endif %}
                        >
                        <label class="form-check-label" for="amix_off">
                            No mixing (takes first track)
                        </label>
                    </div>
                    <div class="form-check">
                        <input
                            class="form-check-input"
                            type="radio"
                            name="amix_mode"
                            id="amix_mix"
                            value="mix"
                            {% if twopass.amix and not twopass.amix_normalize %}checked{% endif %}
                        >
                        <label class="form-check-label" for="amix_mix">
                            Mix tracks
                        </label>
                    </div>
                    <div class="form-check">
                        <input
                            class="form-check-input"
                            type="radio"
                            name="amix_mode"
                            id="amix_mix_normalize"
                            value="mix_normalize"
                            {% if twopass.amix and twopass.amix_normalize %}checked{% endif %}
                        >
                        <label class="form-check-label" for="amix_mix_normalize">
                            Mix tracks + normalize audio
                        </label>
                    </div>
                </div>

                <div class="col" id="audioStreamsCol">
                    <label class="form-label d-block">Audio Streams</label>
                    <div class="row row-cols-2 g-1 mt-1">
                        {% for stream in twopass.audio_streams %}
                        {% set idx = loop.index0 %}
                        <div class="col">
                            <div class="form-check" style="margin-bottom: 0;">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    name="astreams"
                                    id="astream_{{ idx }}"
                                    value="{{ idx }}"
                                    {% if twopass.astreams is not none %}
                                        {% if idx in twopass.astreams %}checked{% endif %}
                                    {% else %}
                                        checked
                                    {% endif %}
                                >
                                <label class="form-check-label" for="astream_{{ idx }}" style="font-size: 0.9rem;">
                                    {{ idx }}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="row mb-3">
                <div class="col">
                    <button id="spinButton" onclick="return startSpin()" class="submission btn btn-primary btn-lg" type="submit">
                        <span class="bi-film"></span> Encode
                    </button>
                    <span id="spinIcon" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden></span>
                </div>
            </div>
            <div class="row mb-3 row-cols-5">
                <div class="col">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="verbose" value="True" name="verbose" id="verbose" {{ "checked" if twopass.verbose else "" }}>
                        <label class="form-check-label" for="verbose">Verbose FFmpeg Logs</label>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#streamDetails" aria-expanded="false" aria-controls="streamDetails">
                        Show input stream details
                    </button>
                </div>
            </div>
            <div class="collapse" id="streamDetails">
                <div class="row mb-3">
                    <div class="col">
                        <h4>Video Streams</h4>
                        {% set video_streams = twopass.probe["streams"] | selectattr("codec_type", "equalto", "video") | list %}
                        {% if video_streams %}
                            <pre class="bg-dark text-light p-3 rounded" style="max-height: 200px; overflow: auto; font-size: 0.8rem;"><code>{% for stream in video_streams %}-- Stream {{ loop.index0 }} --
{% for key, value in stream.items() %}{% if key not in ["disposition", "tags"] %}{{ key }}: {{ value }}
{% endif %}{% endfor %}

{% endfor %}</code></pre>
                        {% else %}
                            <p class="text-muted">No video streams found.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <h4>Audio Streams</h4>
                        {% set audio_streams = twopass.probe["streams"] | selectattr("codec_type", "equalto", "audio") | list %}
                        {% if audio_streams %}
                            <pre class="bg-dark text-light p-3 rounded" style="max-height: 200px; overflow: auto; font-size: 0.8rem;"><code>{% for stream in audio_streams %}-- Stream {{ loop.index0 }} --
{% for key, value in stream.items() %}{% if key not in ["disposition", "tags"] %}{{ key }}: {{ value }}
{% endif %}{% endfor %}

{% endfor %}</code></pre>
                        {% else %}
                            <p class="text-muted">No audio streams found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        const MAX_FILESIZE_MB = parseFloat("{{ twopass.probe['format']['size'] }}") * 0.00000095367432;
        console.log("MAX_FILESIZE_MB:", MAX_FILESIZE_MB);
        const video = document.getElementById('myVideo');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');
        const startTimeLabel = document.getElementById('startTimeLabel');
        const endTimeLabel = document.getElementById('endTimeLabel');

        video.addEventListener('loadedmetadata', () => {
            startTimeInput.value = "{{ twopass.from_seconds if twopass.from_seconds else 0 }}"
            endTimeInput.value = "{{ twopass.to_seconds if twopass.to_seconds else twopass.duration }}"
        });

        startTimeInput.addEventListener('input', updateStartTimeLabel);
        endTimeInput.addEventListener('input', updateEndTimeLabel);

        function updateStartTimeLabel() {
            startTimeLabel.textContent = startTimeInput.value + ' seconds';
        }

        function updateEndTimeLabel() {
            endTimeLabel.textContent = endTimeInput.value + ' seconds';
        }

        function setTime(type) {
            const currentTime = Math.floor(video.currentTime);
            
            if (type === 'start') {
                startTimeInput.value = currentTime;
                startTimeLabel.textContent = currentTime + ' seconds';
            } else if (type === 'end') {
                endTimeInput.value = currentTime;
                endTimeLabel.textContent = currentTime + ' seconds';
            }
        }

        function selectVideoPart() {
            const startTime = parseInt(startTimeInput.value);
            const endTime = parseInt(endTimeInput.value);

            if (!isNaN(startTime) && !isNaN(endTime) && startTime < endTime) {
                video.currentTime = startTime;
                video.play();

                setTimeout(() => {
                    video.pause();
                    video.currentTime = endTime;
                }, (endTime - startTime) * 1000);
            } else {
                alert('Please enter valid start and end times.');
            }
        }

        function startSpin() {
            // Get the icon element
            var icon = document.getElementById('spinIcon');
            icon.hidden = false;

            // Disable the button temporarily to prevent multiple clicks
            document.getElementById('spinButton').disabled = true;

            // Validation for target_filesize
            const targetField = document.getElementById('target_filesize');
            const value = parseFloat(targetField.value);
            if (!isNaN(value) && value > MAX_FILESIZE_MB && MAX_FILESIZE_MB > 0) {
                alert('Target filesize (' + value + ' MB) exceeds the maximum allowed (' + MAX_FILESIZE_MB + ' MB). Please enter a smaller value.');
                targetField.focus();
                // Re-enable the button since submission is blocked
                document.getElementById('spinButton').disabled = false;
                icon.hidden = true;
                return false;
            }

            document.getElementById('encodeForm').submit();
        }

        const checkbox = document.getElementById('approx');
        const span = document.getElementById('targetApprox');

        // Add event listener to the checkbox
        checkbox.addEventListener('change', function() {
            // Check if the checkbox is checked
            if (this.checked) {
                // Update the text inside the span
                span.textContent = 'Approximate';
            } else {
                // Update the text inside the span
                span.textContent = 'Target';
            }
        });

        // Validation is now handled in startSpin()

        function setColumnEnabled(col, enabled) {
            if (!col) return;
            col.querySelectorAll('input, select, textarea, button').forEach((el) => {
                el.disabled = !enabled;
            });
        }

        // Hide/show the "Audio Streams" column depending on Audio Mixing mode
        function toggleAudioStreamsVisibility() {
            const audioStreamsCol = document.getElementById('audioStreamsCol');
            if (!audioStreamsCol) return; // section not rendered when only 1 audio stream

            const includeAudioSwitch = document.getElementById('include_audio');
            if (includeAudioSwitch && !includeAudioSwitch.checked) {
                audioStreamsCol.classList.add('d-none');
                return;
            }

            const amixOff = document.getElementById('amix_off');
            const hide = !!amixOff && amixOff.checked;

            audioStreamsCol.classList.toggle('d-none', hide);
        }

        function toggleAudioOptionsVisibility() {
            const includeAudioSwitch = document.getElementById('include_audio');
            // If the switch isn't present for some reason, default to showing audio options.
            const includeAudio = !includeAudioSwitch || includeAudioSwitch.checked;

            const audioMixingCol = document.getElementById('audioMixingCol');
            const audioStreamsCol = document.getElementById('audioStreamsCol');

            // These sections aren't rendered when only 1 audio stream exists.
            if (!audioMixingCol && !audioStreamsCol) return;

            if (audioMixingCol) {
                audioMixingCol.classList.toggle('d-none', !includeAudio);
            }
            if (audioStreamsCol) {
                audioStreamsCol.classList.toggle('d-none', !includeAudio);
            }

            // Disable hidden audio option inputs so they don't submit values.
            setColumnEnabled(audioMixingCol, includeAudio);
            setColumnEnabled(audioStreamsCol, includeAudio);

            // If we're including audio, apply any additional logic (like hiding streams when mixing is off).
            if (includeAudio) {
                toggleAudioStreamsVisibility();
            }
        }

        // Listen for changes to Audio Mixing radio buttons (if present)
        document.querySelectorAll('input[type="radio"][name="amix_mode"]').forEach((radio) => {
            radio.addEventListener('change', toggleAudioStreamsVisibility);
        });

        // Listen for Include Audio toggle
        const includeAudioSwitch = document.getElementById('include_audio');
        if (includeAudioSwitch) {
            includeAudioSwitch.addEventListener('change', toggleAudioOptionsVisibility);
        }

        // Apply on initial page load
        toggleAudioOptionsVisibility();
    </script>
</body>
</html>
